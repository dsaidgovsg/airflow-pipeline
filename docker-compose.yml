version: '2'
services:
  postgres:
    image: postgres:9.6
    ports:
      - 127.0.0.1:5999:5432
    restart: always
    volumes:
      - postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: fixme
      POSTGRES_PASSWORD: fixme
      POSTGRES_DB: airflow
      TZ: "Asia/Singapore"
  scheduler:
    build:
      context: .
      dockerfile: Dockerfile
    network_mode: "host"
    restart: always
    depends_on:
      - postgres
    environment:
      TZ: "Asia/Singapore"
      AIRFLOW__CORE__SQL_ALCHEMY_CONN: postgresql://fixme:fixme@localhost:5999/airflow
      PYSPARK_PYTHON: /usr/local/bin/python2.7
    command: afp-scheduler
    volumes:
      - airflow_logs:/airflow/logs
  webserver:
    build:
      context: .
      dockerfile: Dockerfile
    network_mode: "host"
    restart: always
    depends_on:
      - scheduler
    environment:
      AIRFLOW__CORE__SQL_ALCHEMY_CONN: postgresql://fixme:fixme@localhost:5999/airflow
      AIRFLOW_USER: fixme
      AIRFLOW_EMAIL: fixme@fix.me
      AIRFLOW_PASSWORD: fixme
    command: afp-webserver
    volumes_from:
      - scheduler
volumes:
  postgres: {}
  airflow_logs: {}
